{"version":3,"file":"FanAPI.js","sourceRoot":"","sources":["../../../../src/lib/fan/FanAPI.ts"],"names":[],"mappings":"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","sourcesContent":["import {type FanItemsContinuation} from '../types/Fan.js';\nimport type Fan from '../types/Fan.js';\nimport { type ImageFormat } from '../types/Image.js';\nimport { URLS } from '../utils/Constants.js';\nimport { FetchError, FetchMethod } from '../utils/Fetcher.js';\nimport { FanContinuationItemsResult, type FanItemParseOptions, FanPageItemsResult } from './FanItemsBaseParser.js';\nimport FanCollectionParser from './FanCollectionParser.js';\nimport FanFollowingParser from './FanFollowingParser.js';\nimport FanInfoParser from './FanInfoParser.js';\nimport FanWishlistParser from './FanWishlistParser.js';\nimport type Album from '../types/Album.js';\nimport type Track from '../types/Track.js';\nimport type UserKind from '../types/UserKind.js';\nimport type Tag from '../types/Tag.js';\nimport type Limiter from '../utils/Limiter.js';\nimport BaseAPIWithImageSupport, { type BaseAPIWithImageSupportParams } from '../common/BaseAPIWithImageSupport.js';\n\nexport { FanPageItemsResult, FanContinuationItemsResult };\n\nexport interface FanAPIGetInfoParams {\n  username?: string;\n  imageFormat: string | number | ImageFormat;\n}\n\nexport interface FanAPIGetItemsParams {\n  target?: string | FanItemsContinuation;\n  imageFormat?: string | number | ImageFormat;\n}\n\n/**\n * @internal\n */\nexport interface FanAPIGetItemsFullParams<T> extends FanAPIGetItemsParams {\n  defaultImageFormat: number;\n  continuationUrl?: string;\n  parsePageFn: (html: string, opts: FanItemParseOptions) => FanPageItemsResult<T>;\n  parseContinuationFn: (json: any, continuation: FanItemsContinuation, opts: FanItemParseOptions) => FanContinuationItemsResult<T>;\n}\n\nexport default class FanAPI extends BaseAPIWithImageSupport {\n\n  async getInfo(params: FanAPIGetInfoParams): Promise<Fan> {\n    if (!params.username) {\n      const username = await this.getLoggedInFanUsername();\n      return this.getInfo({\n        ...params,\n        username\n      });\n    }\n    const imageConstants = await this.imageAPI.getConstants();\n    const fanPageUrl = FanAPI.getFanPageUrl(params.username);\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      imageFormat: await this.imageAPI.getFormat(params.imageFormat, 20)\n    };\n    const html = await this.fetch(fanPageUrl);\n    return FanInfoParser.parseInfo(html, opts);\n  }\n\n  async getCollection(params: FanAPIGetItemsParams) {\n    return await this.getItems({\n      ...params,\n      defaultImageFormat: 9,\n      continuationUrl: URLS.FAN_CONTINUATION.COLLECTION,\n      parsePageFn: FanCollectionParser.parseCollectionFromPage.bind(FanCollectionParser),\n      parseContinuationFn: FanCollectionParser.parseCollectionFromContinuation.bind(FanCollectionParser)\n    });\n  }\n\n  async getWishlist(params: FanAPIGetItemsParams) {\n    return await this.getItems({\n      ...params,\n      defaultImageFormat: 9,\n      continuationUrl: URLS.FAN_CONTINUATION.WISHLIST,\n      parsePageFn: FanWishlistParser.parseWishlistFromPage.bind(FanWishlistParser),\n      parseContinuationFn: FanWishlistParser.parseWishlistFromContinuation.bind(FanWishlistParser)\n    });\n  }\n\n  async getFollowingArtistsAndLabels(params: FanAPIGetItemsParams) {\n    return await this.getItems({\n      ...params,\n      defaultImageFormat: 21,\n      continuationUrl: URLS.FAN_CONTINUATION.FOLLOWING_BANDS,\n      parsePageFn: FanFollowingParser.parseFollowingBandsFromPage.bind(FanFollowingParser),\n      parseContinuationFn: FanFollowingParser.parseFollowingBandsFromContinuation.bind(FanFollowingParser)\n    });\n  }\n\n  async getFollowingGenres(params: FanAPIGetItemsParams) {\n    return await this.getItems({\n      ...params,\n      defaultImageFormat: 3,\n      continuationUrl: URLS.FAN_CONTINUATION.FOLLOWING_GENRES,\n      parsePageFn: FanFollowingParser.parseFollowingGenresFromPage.bind(FanFollowingParser),\n      parseContinuationFn: FanFollowingParser.parseFollowingGenresFromContinuation.bind(FanFollowingParser)\n    });\n  }\n\n  /**\n   * @internal\n   */\n  protected async getItems<T>(params: FanAPIGetItemsFullParams<T>): Promise<FanPageItemsResult<T> | FanContinuationItemsResult<T>> {\n    const { target, imageFormat, defaultImageFormat, continuationUrl } = params;\n\n    if (!target) {\n      const username = await this.getLoggedInFanUsername();\n      return this.getItems({\n        ...params,\n        target: username\n      });\n    }\n\n    const imageConstants = await this.imageAPI.getConstants();\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      imageFormat: await this.imageAPI.getFormat(imageFormat, defaultImageFormat)\n    };\n\n    if (!FanAPI.isContinuation(target)) {\n      const fanPageUrl = FanAPI.getFanPageUrl(target);\n      const html = await this.fetch(fanPageUrl);\n      return params.parsePageFn(html, opts);\n    }\n\n    // Continuation\n    if (!continuationUrl) {\n      throw new FetchError('Unable to fetch fan contents: target is continuation token but continuation URL is missing.');\n    }\n\n    const payload = {\n      fan_id: target.fanId,\n      older_than_token: target.token,\n      count: 20\n    };\n    const json = await this.fetch(continuationUrl, true, FetchMethod.POST, payload);\n    return params.parseContinuationFn(json, target, opts);\n  }\n\n  /**\n   * @internal\n  */\n  protected static getFanPageUrl(username: string) {\n    return `${URLS.SITE_URL}/${username}`;\n  }\n\n  /**\n   * @internal\n  */\n  protected static isContinuation(target: any): target is FanItemsContinuation {\n    return typeof target === 'object' && target.fanId && target.token;\n  }\n\n  /**\n   * @internal\n   */\n  protected async getLoggedInFanUsername() {\n    const html = await this.fetch(URLS.SITE_URL);\n    return FanInfoParser.parseLoggedInFanUsername(html);\n  }\n}\n\nexport class LimiterFanAPI extends FanAPI {\n\n  #limiter: Limiter;\n\n  constructor(params: BaseAPIWithImageSupportParams & { limiter: Limiter }) {\n    super(params);\n    this.#limiter = params.limiter;\n  }\n\n  async getInfo(params: FanAPIGetInfoParams): Promise<Fan> {\n    return this.#limiter.schedule(() => super.getInfo(params));\n  }\n\n  async getCollection(params: FanAPIGetItemsParams): Promise<FanPageItemsResult<NonNullable<Album | Track | null>> | FanContinuationItemsResult<NonNullable<Album | Track | null>>> {\n    return this.#limiter.schedule(() => super.getCollection(params));\n  }\n\n  async getWishlist(params: FanAPIGetItemsParams): Promise<FanPageItemsResult<NonNullable<Album | Track | null>> | FanContinuationItemsResult<NonNullable<Album | Track | null>>> {\n    return this.#limiter.schedule(() => super.getWishlist(params));\n  }\n\n  async getFollowingArtistsAndLabels(params: FanAPIGetItemsParams): Promise<FanPageItemsResult<UserKind> | FanContinuationItemsResult<UserKind>> {\n    return this.#limiter.schedule(() => super.getFollowingArtistsAndLabels(params));\n  }\n\n  async getFollowingGenres(params: FanAPIGetItemsParams): Promise<FanPageItemsResult<Tag> | FanContinuationItemsResult<Tag>> {\n    return this.#limiter.schedule(() => super.getFollowingGenres(params));\n  }\n}\n"]}