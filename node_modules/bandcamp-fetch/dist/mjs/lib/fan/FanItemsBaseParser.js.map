{"version":3,"file":"FanItemsBaseParser.js","sourceRoot":"","sources":["../../../../src/lib/fan/FanItemsBaseParser.ts"],"names":[],"mappings":"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","sourcesContent":["import { load as cheerioLoad } from 'cheerio';\nimport { decode } from 'html-entities';\nimport { type FanItemsContinuation } from '../types/Fan.js';\nimport { type ImageFormat } from '../types/Image.js';\n\ntype PageDataKey = 'collection' | 'wishlist' | 'following_genres' | 'following_bands';\ntype ContinuationDataKey = 'items' | 'followeers';\n\ninterface FanItemsParseParams<T> extends FanItemParseOptions {\n  dataKey: PageDataKey | ContinuationDataKey;\n  parseItemFn: (data: any, opts: FanItemParseOptions, tracklists: any) => T;\n}\n\nexport interface FanPageItemsResult<T> {\n  items: T[];\n  total: number;\n  continuation: FanItemsContinuation | null;\n}\n\nexport interface FanContinuationItemsResult<T> {\n  items: T[];\n  continuation: FanItemsContinuation | null;\n}\n\nexport interface FanItemParseOptions {\n  imageBaseUrl: string;\n  imageFormat: ImageFormat | null;\n}\n\nexport default abstract class FanItemsBaseParser {\n\n  protected static parsePageItems<T>(html: string, params: FanItemsParseParams<T>): FanPageItemsResult<NonNullable<T>> {\n    const _getSequenceOrPending = (o: any) => {\n      return Array.isArray(o.sequence) && o.sequence.length > 0 ? o.sequence :\n        Array.isArray(o.pending_sequence) && o.pending_sequence.length > 0 ? o.pending_sequence : [];\n    };\n\n    const $ = cheerioLoad(html);\n    const blob = decode($('#pagedata[data-blob]').attr('data-blob'));\n    const parsed = JSON.parse(blob);\n    const result: FanPageItemsResult<NonNullable<T>> = {\n      items: [],\n      total: 0,\n      continuation: null\n    };\n\n    const itemListData = parsed[`${params.dataKey}_data`];\n    const itemCache = parsed.item_cache?.[params.dataKey];\n    if (itemListData && itemCache) {\n      const tracklists = parsed.tracklists?.[params.dataKey];\n      const sequence = _getSequenceOrPending(itemListData);\n      const parseFn = params.parseItemFn;\n\n      sequence.forEach((itemKey: string) => {\n        const parsedItem = parseFn(itemCache[itemKey], params, tracklists);\n        if (parsedItem) {\n          result.items.push(parsedItem);\n        }\n      });\n      result.total = itemListData.item_count;\n\n      const fanId = parsed.fan_data && parsed.fan_data.fan_id ? parsed.fan_data.fan_id : null;\n      if (itemListData.item_count > sequence.length && itemListData.last_token && fanId) {\n        result.continuation = {\n          fanId,\n          token: itemListData.last_token\n        };\n      }\n    }\n\n    return result;\n  }\n\n  protected static parseContinuationItems<T>(json: any, continuation: FanItemsContinuation,\n    params: FanItemsParseParams<T>): FanContinuationItemsResult<NonNullable<T>> {\n\n    const items = json[params.dataKey] || [];\n    const tracklists = json.tracklists || null;\n    const parseFn = params.parseItemFn;\n    const result: FanContinuationItemsResult<NonNullable<T>> = {\n      items: [],\n      continuation: null\n    };\n    items.forEach((data: any) => {\n      const parsedItem = parseFn(data, params, tracklists);\n      if (parsedItem) {\n        result.items.push(parsedItem);\n      }\n    });\n    if (json.more_available && json.last_token) {\n      result.continuation = {\n        fanId: continuation.fanId,\n        token: json.last_token\n      };\n    }\n    return result;\n  }\n}\n"]}